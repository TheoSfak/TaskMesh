<div x-data="profilePage()" x-init="loadProfile()" class="space-y-6">
    
    <!-- Profile Header -->
    <div class="glass rounded-3xl p-8" x-show="profile.email">
        <div class="flex items-center gap-6">
            <div class="w-24 h-24 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex items-center justify-center text-white font-bold text-4xl">
                <span x-text="(profile.first_name?.[0] || '') + (profile.last_name?.[0] || '')"></span>
            </div>
            <div class="flex-1">
                <h1 class="text-3xl font-bold text-gray-800" x-text="(profile.first_name || '') + ' ' + (profile.last_name || '')"></h1>
                <p class="text-gray-600" x-text="profile.email"></p>
                <div class="flex items-center gap-2 mt-2">
                    <span class="inline-block px-4 py-2 rounded-lg text-sm font-semibold"
                          :class="{
                              'bg-red-100 text-red-700': profile.role === 'ADMIN',
                              'bg-orange-100 text-orange-700': profile.role === 'MANAGER',
                              'bg-green-100 text-green-700': profile.role === 'MEMBER'
                          }"
                          x-text="profile.role"></span>
                    <template x-if="profile.role === 'MEMBER' && profile.manager_name">
                        <span class="inline-block px-4 py-2 rounded-lg text-sm bg-blue-50 text-blue-700">
                            <i class="fas fa-user-tie mr-1"></i>
                            Manager: <span x-text="profile.manager_name"></span>
                        </span>
                    </template>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading State -->
    <div x-show="!profile.email" class="glass rounded-3xl p-12 text-center">
        <div class="inline-block w-12 h-12 border-4 border-purple-500 border-t-transparent rounded-full animate-spin mb-4"></div>
        <p class="text-gray-600">Φόρτωση προφίλ...</p>
    </div>

    <!-- Edit Profile Form -->
    <div class="glass rounded-3xl p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Επεξεργασία Προφίλ</h2>
        
        <form @submit.prevent="updateProfile" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Όνομα</label>
                    <input type="text" x-model="form.first_name" required
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                </div>

                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Επώνυμο</label>
                    <input type="text" x-model="form.last_name" required
                           class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                <input type="email" x-model="profile.email" disabled
                       class="w-full px-4 py-3 rounded-xl border border-gray-300 bg-gray-100 cursor-not-allowed">
            </div>

            <div>
                <label class="block text-gray-700 font-semibold mb-2">Avatar URL</label>
                <input type="url" x-model="form.avatar"
                       placeholder="https://example.com/avatar.jpg"
                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
            </div>

            <div x-show="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl text-sm" x-text="error"></div>
            <div x-show="success" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl text-sm" x-text="success"></div>

            <button type="submit" :disabled="saving"
                    class="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white font-semibold rounded-xl hover:shadow-lg transition disabled:opacity-50">
                <span x-show="!saving">Αποθήκευση</span>
                <span x-show="saving">Αποθήκευση...</span>
            </button>
        </form>
    </div>

    <!-- Change Password -->
    <div class="glass rounded-3xl p-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-6">Αλλαγή Κωδικού</h2>
        
        <form @submit.prevent="changePassword" class="space-y-6">
            <div>
                <label class="block text-gray-700 font-semibold mb-2">Τρέχων Κωδικός</label>
                <input type="password" x-model="passwordForm.current_password" required
                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
            </div>

            <div>
                <label class="block text-gray-700 font-semibold mb-2">Νέος Κωδικός (τουλάχιστον 8 χαρακτήρες)</label>
                <input type="password" x-model="passwordForm.new_password" required minlength="8"
                       class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:border-purple-500 focus:ring-2 focus:ring-purple-200">
            </div>

            <div x-show="passwordError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-xl text-sm" x-text="passwordError"></div>
            <div x-show="passwordSuccess" class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded-xl text-sm" x-text="passwordSuccess"></div>

            <button type="submit" :disabled="changingPassword"
                    class="px-8 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-xl hover:shadow-lg transition disabled:opacity-50">
                <span x-show="!changingPassword">Αλλαγή Κωδικού</span>
                <span x-show="changingPassword">Αλλαγή...</span>
            </button>
        </form>
    </div>
</div>

<script>
function profilePage() {
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    return {
        user: user,
        profile: {
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            email: user.email || '',
            role: user.role || '',
            avatar: user.avatar || ''
        },
        form: {
            first_name: user.first_name || '',
            last_name: user.last_name || '',
            avatar: user.avatar || ''
        },
        passwordForm: {
            current_password: '',
            new_password: ''
        },
        saving: false,
        changingPassword: false,
        error: '',
        success: '',
        passwordError: '',
        passwordSuccess: '',

        async loadProfile() {
            try {
                const response = await apiRequest('/auth/me.php');
                // The API returns {user: {...}}, so we need to extract the user object
                const userData = response.user || response;
                
                this.profile = {
                    first_name: userData.first_name || '',
                    last_name: userData.last_name || '',
                    email: userData.email || '',
                    role: userData.role || '',
                    avatar: userData.avatar || ''
                };
                
                this.form = {
                    first_name: this.profile.first_name,
                    last_name: this.profile.last_name,
                    avatar: this.profile.avatar
                };
            } catch (err) {
                console.error('Error loading profile:', err);
                // Fallback to localStorage if API fails
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                if (user.email) {
                    this.profile = user;
                    this.form = {
                        first_name: user.first_name || '',
                        last_name: user.last_name || '',
                        avatar: user.avatar || ''
                    };
                }
            }
        },

        async updateProfile() {
            this.saving = true;
            this.error = '';
            this.success = '';

            try {
                const updated = await apiRequest(`/users/index.php?id=${this.user.id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        action: 'profile',
                        ...this.form
                    })
                });

                this.profile = { ...this.profile, ...this.form };
                localStorage.setItem('user', JSON.stringify(this.profile));
                this.success = 'Το προφίλ ενημερώθηκε επιτυχώς!';
                
                setTimeout(() => this.success = '', 3000);
            } catch (err) {
                this.error = err.message;
            } finally {
                this.saving = false;
            }
        },

        async changePassword() {
            this.changingPassword = true;
            this.passwordError = '';
            this.passwordSuccess = '';

            try {
                await apiRequest(`/users/index.php?id=${this.user.id}`, {
                    method: 'PUT',
                    body: JSON.stringify({
                        action: 'profile',
                        current_password: this.passwordForm.current_password,
                        new_password: this.passwordForm.new_password
                    })
                });

                this.passwordSuccess = 'Ο κωδικός άλλαξε επιτυχώς!';
                this.passwordForm = {
                    current_password: '',
                    new_password: ''
                };
                
                setTimeout(() => this.passwordSuccess = '', 3000);
            } catch (err) {
                this.passwordError = err.message;
            } finally {
                this.changingPassword = false;
            }
        }
    }
}
</script>